#cloud-config
output:
  all: '| tee -a /var/log/cloud-init-output.log'
apt_update: true

packages:
  - java-1.8.0-openjdk-headless
  - jq

write_files:
  - path: /etc/systemd/system/minecraftd@.service
    content: |
      [Unit]
      Description=Minecraft Server %i
      After=network.target
      Requires=network.target

      [Service]
      WorkingDirectory=/opt/minecraft/%i
      PrivateUsers=true
      User=ec2-user
      Group=ec2-user
      ProtectSystem=full
      ProtectHome=true
      ProtectKernelTunables=true
      ProtectKernelModules=true
      ProtectControlGroups=true

      # --- Exec commands (executed inside WorkingDirectory)
      ExecStart=/bin/sh -c '/usr/bin/screen -DmS mc-%i /usr/bin/java -server -Xms512M -Xmx1G -XX:+UseG1GC -XX:+CMSIncrementalPacing -XX:+CMSClassUnloadingEnabled -XX:ParallelGCThreads=2 -XX:MinHeapFreeRatio=5 -XX:MaxHeapFreeRatio=10 -jar $(ls -v | grep -i "FTBServer.*jar\|server.*jar" | head -n1) nogui'

      ExecReload=/usr/bin/screen -p 0 -S mc-%i -X eval 'stuff "reload"\\015'

      ExecStop=/opt/scripts/shutdown %i

      StandardOutput=syslog
      StandardError=syslog
      SyslogIdentifier=mc-%i

      Restart=on-failure
      RestartSec=60s

      [Install]
      WantedBy=multi-user.target
    owner: ec2-user:ec2-user
    permissions: '0750'

runcmd:
  - yum -y update
  - mkdir -p /opt/scripts
  - mkdir -p /opt/minecraft/backups
  - aws ec2 associate-address --instance-id `curl -s http://169.254.169.254/latest/meta-data/instance-id` --allocation-id ${eip_alloc} --allow-reassociation --region=${region}
  - aws s3 cp s3://${s3_bucket_name}/backups/${server_name}.tgz /opt/minecraft
  - tar -xvf /opt/minecraft/${server_name}.tgz -C /opt/minecraft
  - aws s3 cp s3://${s3_bucket_name}/scripts /opt/scripts --recursive
  - chown -R ec2-user:ec2-user /opt/minecraft
  - chown -R ec2-user:ec2-user /opt/scripts
  - chmod +x /opt/scripts/*
  - systemctl enable minecraftd@${server_name}
  - systemctl start minecraftd@${server_name}
